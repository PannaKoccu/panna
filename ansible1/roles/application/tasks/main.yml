- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: devops
    group: devops
    mode: '0755'
  become: true
  
- name: Clone application repository
  git:
    repo: https://github.com/PannaKoccu/task1.git
    dest: "{{ app_dir }}"
    version: main
    force: true

- name: Create virtual environment directory
  file:
    path: "{{ venv_dir }}"
    state: directory
    owner: devops
    group: devops
    mode: '0755'

- name: Create virtual environment without pip
  command: python3 -m venv --without-pip "{{ venv_dir }}"
  args:
    creates: "{{ venv_dir }}/bin/python"
  become: true

- name: Download get-pip.py
  get_url:
    url: https://bootstrap.pypa.io/get-pip.py
    dest: /tmp/get-pip.py
    mode: '0644'
  become: true

- name: Install pip into virtual environment
  command: "{{ venv_dir }}/bin/python /tmp/get-pip.py"
  args:
    creates: "{{ venv_dir }}/bin/pip"
  become: true

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ app_dir }}/.env"
    owner: devops
    group: devops
    mode: '0600'
  become: true

- name: Install Python dependencies
  ansible.builtin.pip:
    requirements: "{{ app_dir }}/requirements.txt"
    executable: "{{ venv_dir }}/bin/pip"
    state: present
  become: true

- name: Create application log directory
  file:
    path:  "{{ log_dir }}"
    state: directory
    owner: devops
    group: devops
    mode: '0755'
  become: true

- name: Check if application log file exists
  stat:
    path: "{{ app_log_file }}"
  register: app_log_stat
  become: true

- name: Create empty application log file if absent
  file:
    path: "{{ app_log_file }}"
    state: touch
    owner: devops
    group: devops
    mode: '0644'
  when: not app_log_stat.stat.exists
  become: true

- name: Copy systemd service file
  template:
    src: task1.service.j2
    dest: "{{ systemd_service }}"
    owner: root
    group: root
    mode: '0644'
  notify: Restart task1

- name: Enable and start task1 service
  systemd:
    name: task1
    state: started
    enabled: true
  become: true