#!/bin/bash
# test-deployment.sh - –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
# –ó–ê–ü–£–°–ö–ê–¢–¨ –¢–û–õ–¨–ö–û –ù–ê VM1 (application + database server)

set -e

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
APP_URL="http://localhost:{{ app_port }}"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"
BACKUP_DIR="/var/log/task1/backups"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# === 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞ ===
log "üîç –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL")
if [[ "$HTTP_CODE" =~ ^[23][0-9][0-9]$ ]]; then
    log "‚úÖ –ë—ç–∫–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_CODE)"
else
    log "‚ùå –ë—ç–∫–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_CODE)"
    exit 1
fi

# === 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î ===
log "üîç –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"
if ! psql -d "$DB_NAME" -U "$DB_USER" -c "SELECT 1;" > /dev/null 2>&1; then
    log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î"
    exit 1
fi
log "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ"

# === 3. –¢–µ—Å—Ç backup –∏ restore ===
log "üîç –¢–µ—Å—Ç 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ backup –∏ restore"

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –ø—É—Å—Ç–∞
if ! psql -d "$DB_NAME" -U "$DB_USER" -c "SELECT 1 FROM "user" LIMIT 1;" > /dev/null 2>&1; then
    log "‚ùå –¢–∞–±–ª–∏—Ü–∞ 'user' –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å."
    exit 1
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
COUNT_BEFORE=$(psql -d "$DB_NAME" -U "$DB_USER" -t -c "SELECT COUNT(*) FROM "user";" 2>/dev/null | tr -d ' ')
log "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–æ –±—ç–∫–∞–ø–∞: $COUNT_BEFORE"

# –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π backup
log "–ó–∞–ø—É—Å–∫–∞–µ–º /home/devops/task1/flask-auth-example/backup.sh"
sudo -u devops {{ app_dir }}/backup.sh

# –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø
LATEST_BACKUP=$(ls -t "$BACKUP_DIR"/*.sql.gz 2>/dev/null | head -1)
if [ -z "$LATEST_BACKUP" ]; then
    log "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –≤ $BACKUP_DIR"
    exit 1
fi
log "–ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: $LATEST_BACKUP"

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
log "–£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã 'user'"
psql -d "$DB_NAME" -U "$DB_USER" -c 'DELETE FROM "user";' > /dev/null

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞
COUNT_AFTER_DELETE=$(psql -d "$DB_NAME" -U "$DB_USER" -t -c 'SELECT COUNT(*) FROM "user";' 2>/dev/null | tr -d ' ')
if [ "$COUNT_AFTER_DELETE" -ne 0 ]; then
    log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É (–æ—Å—Ç–∞–ª–æ—Å—å: $COUNT_AFTER_DELETE)"
    exit 1
fi
log "–¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞"

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –±—ç–∫–∞–ø–∞
log "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ë–î –∏–∑ –±—ç–∫–∞–ø–∞"
gunzip -c "$LATEST_BACKUP" | psql -d "$DB_NAME" -U "$DB_USER"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
COUNT_AFTER_RESTORE=$(psql -d "$DB_NAME" -U "$DB_USER" -t -c "SELECT COUNT(*) FROM "user";" 2>/dev/null | tr -d ' ')
if [ "$COUNT_AFTER_RESTORE" -eq "$COUNT_BEFORE" ]; then
    log "‚úÖ Backup –∏ restore —Ä–∞–±–æ—Ç–∞—é—Ç! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: $COUNT_AFTER_RESTORE"
else
    log "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (–±—ã–ª–æ: $COUNT_BEFORE, —Å—Ç–∞–ª–æ: $COUNT_AFTER_RESTORE)"
    exit 1
fi

log "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"