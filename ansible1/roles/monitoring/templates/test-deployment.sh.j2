#!/bin/bash
# test-deployment.sh - Полная валидация после развёртывания

set -e

# Настройки
APP_URL="http://localhost:{{ app_port }}"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"
BACKUP_DIR="/var/log/task1/backups"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# === 1. Проверка локального бэкенда ===
log "Проверка локального бэкенда"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL")
if [[ "$HTTP_CODE" =~ ^[23][0-9][0-9]$ ]]; then
    log "Бэкенд доступен (HTTP $HTTP_CODE)"
else
    log "Бэкенд недоступен (HTTP $HTTP_CODE)"
    exit 1
fi

# === 2. Проверка подключения к локальной БД ===
log "Проверка подключения к БД"
if ! psql -d "$DB_NAME" -U "$DB_USER" -c "SELECT 1;" > /dev/null 2>&1; then
    log "Не удалось подключиться к БД"
    exit 1
fi
log "Подключение к БД успешно"

# === 3. Тест backup и restore ===
log "Тестирование backup и restore"

# Убедимся, что таблица не пуста
if ! psql -d "$DB_NAME" -U "$DB_USER" -c "SELECT 1 FROM "user" LIMIT 1;" > /dev/null 2>&1; then
    log "Таблица 'user' пуста. Добавьте пользователя через веб-интерфейс."
    exit 1
fi

# Сохраняем количество записей
COUNT_BEFORE=$(psql -d "$DB_NAME" -U "$DB_USER" -t -c "SELECT COUNT(*) FROM "user";" 2>/dev/null | tr -d ' ')
log "Количество записей до бэкапа: $COUNT_BEFORE"

# Запускаем локальный backup
log "Запускаем /home/devops/task1/flask-auth-example/backup.sh"
sudo -u devops {{ app_dir }}/backup.sh

# Находим последний бэкап
LATEST_BACKUP=$(ls -t "$BACKUP_DIR"/*.sql.gz 2>/dev/null | head -1)
if [ -z "$LATEST_BACKUP" ]; then
    log "Не найдено ни одного бэкапа в $BACKUP_DIR"
    exit 1
fi
log "Последний бэкап: $LATEST_BACKUP"

# Удаляем все записи
log "Удаляем все записи из таблицы 'user'"
psql -d "$DB_NAME" -U "$DB_USER" -c 'DELETE FROM "user";' > /dev/null

# Проверяем, что таблица пуста
COUNT_AFTER_DELETE=$(psql -d "$DB_NAME" -U "$DB_USER" -t -c 'SELECT COUNT(*) FROM "user";' 2>/dev/null | tr -d ' ')
if [ "$COUNT_AFTER_DELETE" -ne 0 ]; then
    log "Не удалось очистить таблицу (осталось: $COUNT_AFTER_DELETE)"
    exit 1
fi
log "Таблица успешно очищена"

# Восстанавливаем из бэкапа
log "Восстанавливаем БД из бэкапа"
gunzip -c "$LATEST_BACKUP" | psql -d "$DB_NAME" -U "$DB_USER"

# Проверяем восстановление
COUNT_AFTER_RESTORE=$(psql -d "$DB_NAME" -U "$DB_USER" -t -c "SELECT COUNT(*) FROM "user";" 2>/dev/null | tr -d ' ')
if [ "$COUNT_AFTER_RESTORE" -eq "$COUNT_BEFORE" ]; then
    log "Backup и restore работают."
else
    log "Количество записей не совпадает"
    exit 1
fi

log "Все тесты пройдены успешно."