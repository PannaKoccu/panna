#!/bin/bash
# healthcheck.sh - Мониторинг Nginx и удалённого бэкенда
# Запускается на веб-сервере

set -e

LOG_FILE="/var/log/task1/healthcheck.log"
NGINX_URL="https://{{ nginx_ip }}"
BACKEND_URL="http://{{ app_server_ip }}:{{ app_port }}"


mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

http_code() {
    curl -k -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 15 "$1"
}

check_nginx() {
    if code=$(http_code "$NGINX_URL"); then
        [[ "$code" =~ ^[23][0-9][0-9]$ ]] && log "Nginx доступен (HTTP $code)" || { log "Nginx вернул ошибку (HTTP $code)"; exit 1; }
    else
        log "Nginx недоступен (ошибка соединения)"
        exit 1
    fi
}

check_backend() {
    if code=$(http_code "$BACKEND_URL"); then
        if [[ "$code" =~ ^[12345][0-9][0-9]$ ]]; then
            log "Бэкенд доступен (HTTP $code)"
            [[ ! "$code" =~ ^2 ]] && log "Бэкенд отвечает, но статус не 2xx: $code"
        else
            log "Некорректный HTTP-код от бэкенда: '$code'"
            exit 1
        fi
    else
        log "Бэкенд недоступен (ошибка соединения)"
        exit 1
    fi
}

check_database() {
    log "Проверка подключения к базе данных"
    if sudo -u devops psql \
        "host={{ app_server_ip }} port=5432 dbname={{ db_name }} user={{ db_user }}" \
        -c "SELECT 1;" > /dev/null 2>&1; then
        log "✅ База данных доступна"
    else
        log "❌ Не удалось подключиться к базе данных"
        exit 1
    fi
}

log "=== Начало проверки состояния ==="

check_nginx
check_backend
check_database


# Мониторинг ресурсов
disk=$(df -h / | awk 'NR==2 {print $5}' | tr -d '%')
log "Дисковое пространство: $disk% использовано"
(( disk > 90 )) && log "КРИТИЧНО: диск заполнен на $disk%!"

cpu=$(uptime | awk -F 'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
log "CPU load (1 мин): $cpu"
cpu=$(uptime | awk -F 'load average:' '{print $2}' | awk '{print $2}' | tr -d ',')
log "CPU load (5 мин): $cpu"
cpu=$(uptime | awk -F 'load average:' '{print $2}' | awk '{print $3}' | tr -d ',')
log "CPU load (15 мин): $cpu"

mem_total=$(free -m | awk 'NR==2 {print $2}')
mem_used=$(free -m | awk 'NR==2 {print $3}')
mem_usage=$((100 * mem_used / mem_total))
log "Память: $mem_usage% ($mem_used/$mem_total MB)"
(( mem_usage > 90 )) && log "КРИТИЧНО: память заполнена на $mem_usage%!"

log "=== Проверка завершена успешно ==="