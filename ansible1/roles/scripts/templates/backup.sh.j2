#!/bin/bash
# backup.sh - Резервное копирование базы данных PostgreSQL
# Расположение: {{ app_dir }}/backup.sh

set -e

# Настройки
APP_DIR="{{ app_dir }}"
BACKUP_DIR="$APP_DIR/backups"
LOG_FILE="$home/devops/logs/backup.log"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"
DB_HOST="localhost"

# Создаём директории
mkdir -p "$BACKUP_DIR"
mkdir -p "$(dirname "$LOG_FILE")"

# Функция логирования
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "=== Начало резервного копирования ==="

# Генерируем имя файла с временной меткой
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
DUMP_FILE="$BACKUP_DIR/backup_$TIMESTAMP.sql"

# --- 1. Создание дампа БД ---
log "Создание дампа базы данных '$DB_NAME'..."
pg_dump -U "$DB_USER" -h "$DB_HOST" "$DB_NAME" > "$DUMP_FILE"

if [ $? -eq 0 ]; then
    log "✅ Дамп создан: $DUMP_FILE"
else
    log "❌ Ошибка при создании дампа!"
    exit 1
fi

# --- 2. Сжатие архива ---
log "Сжатие дампа с помощью gzip..."
gzip "$DUMP_FILE"

if [ $? -eq 0 ]; then
    log "✅ Архив сжат: ${DUMP_FILE}.gz"
else
    log "❌ Ошибка при сжатии архива!"
    exit 1
fi

# --- 3. Ротация: оставить последние 7 бэкапов ---
log "Ротация бэкапов (оставляем последние 7)..."
ls -t "$BACKUP_DIR"/backup_*.sql.gz | tail -n +8 | xargs -r rm --

if [ $? -eq 0 ]; then
    log "✅ Старые бэкапы удалены (оставлено 7)"
else
    log "⚠️  Ошибка при удалении старых бэкапов (возможно, их < 8)"
fi

log "=== Резервное копирование завершено ==="
