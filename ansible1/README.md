**Требования к системе**:

Локальная машина (Ansible Controller):
-  ОС: Linux, macOS или Windows
- Ansible ≥ 2.10
- Python ≥ 3.8
- SSH-клиент
- Доступ к интернету
- Свободное место: ~2 ГБ

Виртуальные машины (2 ВМ на базе VirtualBox, VMware или Vagrant):  
- ОС: Ubuntu 22.04 LTS (Server)
- Сетевой режим: Bridged
- Минимальные ресурсы на ВМ:
    - CPU: 1 ядро
    - RAM: 1 ГБ
    - HDD: 10 ГБ
    - Начальный пользователь с паролем (для удобства, чтобы не переписывать 19a04a1976) и именем vm1=test1, vm2=test2.
    - Открытый порт 22 (SSH) на обеих ВМ

**Сетевые настройки**:

- IP от VM1 (Application + DB) и VM2 (Web Server) нужно заменить в inventory файлах и файле all.yml
- Хостовая машина: должна иметь доступ к этим IP
- В файле /etc/hosts на хосте нужно добавить: ip2 `app.devops.local` где ip2 - ip второй vm с веб-сервером.

**Пошаговая инструкция по развертыванию**:

- Создайте 2 виртуальные машины с Ubuntu 22.04 LTS Server и в настройках сети добавьте сетевой мост.
- При создании двух vm(можно позже отдельно) создайте пользователя devops.
- Убедитесь, что пользователь имеет права sudo.
- По умолчанию порт 22 открыт без ufw, но если установлен, то откройте.
- С помощью команды `hostname -I` узнайте ip адреса двух vm и впишите, как сказано в пункте с сетевыми настройками.
- Создайте на своей машине ssh ключи с помощью команд:
  - ssh-keygen -t rsa -b 4096 -C "devops@vm1" -f ~/.ssh/id_rsa_vm1.
  - ssh-keygen -t rsa -b 4096 -C "devops@vm2" -f ~/.ssh/id_rsa_vm2.
- далее скопируйте эти ключи на виртуальные машины с помощью команд:
  - ssh-copy-id -i ~/.ssh/id_rsa_vm1.pub devops@(ip vm1).
  - ssh-copy-id -i ~/.ssh/id_rsa_vm2.pub devops@(ip vm2).
- На основном хосте склонируйте репозиторий https://github.com/PannaKoccu/panna.git и зайдите в папку ansible1 в терминале.
- Далее в терминале вставьте команду: 
  - `ansible-playbook playbooks/site.yml --ask-become-pass --ask-vault-pass`. Введите пароль от sudo и пароль от vault(1976).
- Когда проект развернулся на виртуальных машинах, нужно зайти на vm1 и запустить скрипт test-deployment.sh, он будет много раз спрашивать пароль от БД, вводим (1976). Этот скрипт нужен для полной проверки всего проекта, включая базу данных, её бекапы и восстановление из бекапов.

**Повторный запуск и обновления**:

Также существует playbook для обновления приложения. Запускается командой:
- `ansible-playbook playbooks/update.yml --ask-vault-pass`.
 
**Описание архитектуры**:

- `Директория group_vars`: Содержит директории `vm1` и `vm2`, в них файлы `vault.yml`. Эти файлы содержат секреты, такие как пароль от БД и ключ. Так же в директории group_vars есть файл `all.yml` - это общие переменные для всех vm. 

- Директория `playbooks` содержит playbook `site.yml` для полной настройки сервера и `deploy.yml` для обновления приложения.

- Файл `ansible.cfg` содержит базовую настройку ansible(пути к ролям, inventory и тд.)

- Файл `inventory.ini` содержит пути к ключам, ip виртуальных машин.

**Описание ролей**:

**Роль**: `common`
-
`Назначение`:  
  Базовая настройка ОС на всех серверах.

`Выполняет`:
- Настройка SSH: отключение входа по паролю и root login (меняет строки в конфиг файле).
- Установка базовых пакетов (`curl`, `git`, `python3-pip` и др.).
- Настройка и включение UFW (разрешены порты 22, 80, 443, 5000, 5432).

`Handlers`:
- restart ssh — перезапуск SSH после изменения конфига.

**Роль**: `database`
-
`Назначение`:
Установка и настройка базы данных.

`Выполняет`:
- Установка postgresql и её зависимостей.
- Проверяет, что БД запущена.
- Создаёт кластер для работы БД (без этого БД вообще не работала).
- Копируем шаблон `pg_hba.conf` (Этот файл управляет аутентификацией клиентов, нужно для удалённого подключения,например в скриптах).
- Копируем шаблон файла конфигурации `postgresql.con.f`.
- Создаём пользователя БД
- Создаём БД.

`Используемые переменные`:
- db_password
- db_user

`Handlers`:
- Restart PostgreSQL (перезапускает БД)

`Templates`:
- pg_hba.conf.j2
- postgresql.conf.j2 

**Роль**: `application`
-
`Назначение`:
Клонируем и настраиваем сам сайт.

`Выполняет`:
- Создание директории под приложение.
- Клонирования репозитория с приложением.
- Создание виртуального окружения в определённой директории и установка внутрь него pip. (окружение сразу с pip почему то выдавало ошибку в плейбуке, пришлось установить самому).
- Создаём .env файл для приложения. (для подключения к БД).
- Создаём директорию для логов и логфайл.
- Копируем шаблон task1.service.j2, делаем прилжение контролируемым systemctl.
- Запускаем сервис(приложение).

`Используемые переменные`:
- app_dir 
- venv_dir
- db_user
- db_password
- db_name

`Handlers`:
- Restart task1 (перезапуск сервиса).

`Templates`:
- env.j2
- task1.service.j2

**Роль**: `webserver`
-
`Назначение`:
Установка и настройка nginx с самоподписанным сертификатом.

`Выполняет`:
- Установка nginx.
- Создание директории под SSL и генерируем приватный ключ.
- Создаёт запрос на подпись сертификата.
- На основе CSR и приватного ключа создаёт самоподписанный SSL-сертификат
- Копируем шаблон app.devops.local.conf.j2. (шаблон конфигурации nginx).
- Включение виртуального хоста.
- Удаление стандартного сайта.
- Создание директории для логов Nginx.

`Используемые переменные`:
- domain_name
- app_server_ip
- nginx_ip
- app_port

`Handlers`:
- restartNginx

`Templates`:
- app.devops.local.conf.j2.

**Роль**: `scripts`
-
`Назначение`:
Копирование скриптов, создание директории длялогов и настройка cron на бекап.

`Выполняет`:
- Создание директории под логи скриптов и бекапы.
- Копирует шаблоны setup.sh и backup.sh.
- Устанавливает cron на бекап.

`Используемые переменные`:
- app_dir
- db_name
- db_user

`Templates`:
- setup.sh.j2
- backup.sh.j2

**Роль**: `monitoring`
-
`Назначение`:
Копирование скриптов healthcheck.sh и test-deployment.sh. Копирование pgpass и настройка logrotate.

`Выполняет`:
- Копирует на vm2 скрипт healthcheck.sh.
- Настраивает cron для healthcheck.sh.
- Создаём на всех vm конфиги logrotate.
- Копируем из шаблона .pgpass для доступа к БД.
- Копируем скрипт test-deployment.sh.

`Используемые переменные`:
- app_dir
- db_name
- db_user
- db_password
- app_server_ip
- nginx_ip
- app_port

`Templates`:
- healthcheck.sh.j2
- pgpass.j2
- test-deployment.sh.j2

**Роль**: `monitoring`
-
`Назначение`:
Обновление приложения.

`Выполняет`:
- Клонирование репозитория с приложением.
- установка зависимостей из файла.


  




    